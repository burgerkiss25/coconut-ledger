<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Coconut Ledger (Online / Free)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{display:block;font-size:12px;margin-bottom:4px}
    input,select,button{padding:10px;font-size:14px;min-width:160px}
    .xs{min-width:120px}
    .wide{min-width:240px}
    .box{border:1px solid #ddd;padding:12px;border-radius:8px;margin-top:12px}
    .muted{color:#555;font-size:12px;white-space:pre-line}
    .danger{color:#b00020;font-weight:700}
    .ok{color:#0a6;font-weight:700}
    .btn{cursor:pointer}
    .pill{display:inline-block;padding:3px 8px;border:1px solid #ccc;border-radius:999px;font-size:12px}
    .hr{height:1px;background:#eee;margin:10px 0}
  </style>
</head>
<body>
  <h3>Coconut Ledger (Online / Free)</h3>
  <div class="muted">
    Abrechnung: <b>Owner Due = Paid Given * 6</b> (Broken ist Option 1 = nur KPI, wird NICHT vom Stock abgezogen).<br/>
    Kontrolle: <b>Sold aus Sales</b> → <b>Sold*6</b>. Debt wird automatisch geführt.
  </div>

  <div class="box" id="authBox">
    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="you@example.com"/>
      </div>
      <div>
        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••"/>
      </div>
      <button class="btn" id="loginBtn">Login</button>
      <button class="btn" id="logoutBtn" style="display:none">Logout</button>
      <span id="rolePill" class="pill" style="display:none"></span>
    </div>
    <div id="authMsg" class="muted"></div>
  </div>

  <div class="box" id="appBox" style="display:none">
    <div class="row">
      <div>
        <label>Joint</label>
        <select id="joint"></select>
      </div>
      <div>
        <label>Datum</label>
        <input id="date" type="date" class="xs"/>
      </div>
      <div><label>Start Table</label><input id="startTable" type="number" value="0"/></div>

      <!-- Delivery: only shown when user clicks "Add New Coconuts" -->
      <div>
        <button class="btn" id="toggleDeliveryBtn">+ Add New Coconuts</button>
      </div>
    </div>

    <div id="deliveryBox" class="box" style="display:none;margin-top:10px">
      <div class="muted"><b>Delivery / Wareneingang</b> (nur wenn wirklich neue Kokosnüsse reinkommen)</div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>Type</label>
          <select id="deliveryType" class="xs">
            <option value="local">Local</option>
            <option value="agric">Agric</option>
          </select>
        </div>
        <div><label>Quantity</label><input id="deliveryQty" type="number" value="0" class="xs"/></div>
        <button class="btn" id="addDeliveryBtn">Add</button>
        <button class="btn" id="clearDeliveryBtn">Clear Delivery</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Given Local (auto)</label><input id="givenLocal" type="number" value="0" readonly/></div>
        <div><label>Given Agric (auto)</label><input id="givenAgric" type="number" value="0" readonly/></div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <div><label>Transfer IN</label><input id="transferIn" type="number" value="0"/></div>
      <div><label>Transfer OUT</label><input id="transferOut" type="number" value="0"/></div>
      <div><label>Sales (GHS)</label><input id="salesGhs" type="number" value="0"/></div>
      <div><label>Broken (KPI only)</label><input id="broken" type="number" value="0"/></div>

      <div><label>Paid Cash (GHS)</label><input id="paidCash" type="number" value="0"/></div>
      <div><label>Paid MoMo (GHS)</label><input id="paidMoMo" type="number" value="0"/></div>
      <div><label>Paid Total (auto)</label><input id="paidTotal" type="number" value="0" readonly/></div>
      <div><label>MoMo Ref (optional)</label><input id="momoRef" type="text" class="wide" placeholder="Transaction ID / Sender"/></div>

      <button class="btn" id="saveBtn">Save (Enter)</button>
    </div>

    <div class="row" style="margin-top:10px">
      <div><label>Sell Price</label><input id="sellPrice" class="xs" type="number" value="7"/></div>
      <div><label>Owner Due / Coconut</label><input id="duePer" class="xs" type="number" value="6"/></div>
      <div><label>Bonus %</label><input id="bonusPct" class="xs" type="number" value="10"/></div>
    </div>

    <div id="result" class="muted" style="margin-top:10px"></div>
    <div id="debtBox" class="muted" style="margin-top:8px"></div>

    <!-- Events -->
    <div class="box" style="margin-top:12px">
      <div class="muted"><b>Events</b> (Foreman kann anfragen, Admin approved)</div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="addEventBtn">Add Event Request</button>
        <button class="btn" id="loadEventsBtn">Reload Events</button>
      </div>
      <div id="eventsList" class="muted" style="margin-top:10px"></div>
      <div id="adminApprovals" class="muted" style="margin-top:10px"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Supabase Project Settings -> API
    const SUPABASE_URL = "PASTE_SUPABASE_URL_HERE";
    const SUPABASE_ANON_KEY = "PASTE_SUPABASE_ANON_KEY_HERE";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);

    const authMsg = $("authMsg");
    const appBox = $("appBox");
    const rolePill = $("rolePill");

    const loginBtn = $("loginBtn");
    const logoutBtn = $("logoutBtn");

    const jointEl = $("joint");
    const dateEl = $("date");

    const resultEl = $("result");
    const debtBox = $("debtBox");
    const saveBtn = $("saveBtn");

    // Delivery UI
    const toggleDeliveryBtn = $("toggleDeliveryBtn");
    const deliveryBox = $("deliveryBox");
    const deliveryType = $("deliveryType");
    const deliveryQty = $("deliveryQty");
    const addDeliveryBtn = $("addDeliveryBtn");
    const clearDeliveryBtn = $("clearDeliveryBtn");

    let CURRENT_ROLE = "foreman";

    const fields = {
      startTable: $("startTable"),
      givenLocal: $("givenLocal"),
      givenAgric: $("givenAgric"),
      transferIn: $("transferIn"),
      transferOut: $("transferOut"),
      salesGhs: $("salesGhs"),
      broken: $("broken"),
      paidCash: $("paidCash"),
      paidMoMo: $("paidMoMo"),
      paidTotal: $("paidTotal"),
      momoRef: $("momoRef"),
      sellPrice: $("sellPrice"),
      duePer: $("duePer"),
      bonusPct: $("bonusPct"),
    };

    function todayISO(){
      const d=new Date();
      const yyyy=d.getFullYear();
      const mm=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function calcBonus(paidGiven, bonusPct){
      return Math.round(paidGiven * (bonusPct/100));
    }

    function syncPaidTotal(){
      const paidCash = Number(fields.paidCash.value)||0;
      const paidMoMo = Number(fields.paidMoMo.value)||0;
      fields.paidTotal.value = (paidCash + paidMoMo).toFixed(2);
    }

    function compute(){
      const sellPrice = Number(fields.sellPrice.value) || 7;
      const duePer = Number(fields.duePer.value) || 6;
      const bonusPct = Number(fields.bonusPct.value) || 10;

      const startTable = Number(fields.startTable.value)||0;
      const givenLocal = Number(fields.givenLocal.value)||0;
      const givenAgric = Number(fields.givenAgric.value)||0;
      const transferIn = Number(fields.transferIn.value)||0;
      const transferOut = Number(fields.transferOut.value)||0;
      const salesGhs = Number(fields.salesGhs.value)||0;
      const broken = Number(fields.broken.value)||0; // KPI only
      const paidCash = Number(fields.paidCash.value)||0;
      const paidMoMo = Number(fields.paidMoMo.value)||0;
      const paidGhs = paidCash + paidMoMo;
      const momoRef = (fields.momoRef.value || "").trim();

      const paidGiven = givenLocal + givenAgric;
      const bonus = calcBonus(paidGiven, bonusPct);

      const sold = Math.floor(salesGhs / sellPrice);

      const ownerDueGiven = paidGiven * duePer; // main rule
      const ownerDueSales = sold * duePer;      // control value

      // Broken = KPI only (Option 1): does NOT reduce stock
      const available = startTable + paidGiven + bonus + transferIn - transferOut;
      const remaining = available - sold;

      const deltaGiven = paidGhs - ownerDueGiven;

      return {
        sellPrice, duePer, bonusPct,
        startTable, givenLocal, givenAgric, transferIn, transferOut,
        salesGhs, broken,
        paidCash, paidMoMo, paidGhs, momoRef,
        paidGiven, bonus, sold,
        ownerDueGiven, ownerDueSales,
        remaining, deltaGiven
      };
    }

    async function loadRole(session){
      try{
        const { data: roleRow } = await supabase
          .from("profiles")
          .select("role")
          .eq("user_id", session.user.id)
          .maybeSingle();
        CURRENT_ROLE = roleRow?.role || "foreman";
      } catch {
        CURRENT_ROLE = "foreman";
      }
      rolePill.style.display = "inline-block";
      rolePill.textContent = `role: ${CURRENT_ROLE}`;
    }

    async function loadJoints(){
      const { data, error } = await supabase.from("joints").select("id,name").order("name");
      if (error) { authMsg.textContent = "Fehler joints: " + error.message; return; }
      jointEl.innerHTML = data.map(j => `<option value="${j.id}">${j.name}</option>`).join("");
      await refreshDebt();
    }

    async function refreshDebt(){
      const jointId = jointEl.value;
      if (!jointId) return;
      const { data, error } = await supabase.from("joint_balances").select("debt_ghs").eq("joint_id", jointId).maybeSingle();
      if (error) return;
      const debt = data?.debt_ghs ? Number(data.debt_ghs) : 0;
      const cls = debt > 0 ? "danger" : "ok";
      debtBox.innerHTML = `Current Debt (offen): <span class="${cls}"><b>${debt.toFixed(2)} GHS</b></span>`;
    }

    async function upsertDebt(jointId, debtDelta){
      const { data: bal } = await supabase.from("joint_balances").select("debt_ghs").eq("joint_id", jointId).maybeSingle();
      const current = bal?.debt_ghs ? Number(bal.debt_ghs) : 0;
      const next = current + debtDelta;

      const { error } = await supabase.from("joint_balances").upsert({
        joint_id: jointId,
        debt_ghs: next,
        updated_at: new Date().toISOString()
      });
      if (error) throw error;
      return next;
    }

    function renderCalc(c, newDebt=null){
      const payCls = c.deltaGiven < 0 ? "danger" : "ok";
      resultEl.innerHTML = `
        <div>Paid Given: <b>${c.paidGiven}</b> | Bonus: <b>${c.bonus}</b> | Sold: <b>${c.sold}</b></div>
        <div>Owner Due (Given*6): <b>${c.ownerDueGiven.toFixed(2)} GHS</b></div>
        <div>Kontrolle (Sold*6): <b>${c.ownerDueSales.toFixed(2)} GHS</b></div>
        <div class="${payCls}">Paid Total: <b>${c.paidGhs.toFixed(2)} GHS</b> (Cash ${c.paidCash.toFixed(2)} / MoMo ${c.paidMoMo.toFixed(2)}) |
          Paid - Due(Given): <b>${c.deltaGiven.toFixed(2)} GHS</b></div>
        <div>Soll-Rest (Kontrolle): <b>${c.remaining}</b></div>
        <div class="muted">Broken (KPI only): ${c.broken}</div>
      `;
      if (newDebt !== null) {
        const cls = newDebt > 0 ? "danger" : "ok";
        debtBox.innerHTML = `Current Debt (offen): <span class="${cls}"><b>${newDebt.toFixed(2)} GHS</b></span>`;
      }
    }

    async function saveEntry(){
      const c = compute();
      syncPaidTotal();
      renderCalc(c);

      const jointId = jointEl.value;
      const entryDate = dateEl.value || todayISO();

      // debt increases if due > paid
      const debtDelta = c.ownerDueGiven - c.paidGhs; // positive => debt increases
      const newDebt = await upsertDebt(jointId, debtDelta);

      const payload = {
        entry_date: entryDate,
        joint_id: jointId,
        start_table: c.startTable,
        given_local: c.givenLocal,
        given_agric: c.givenAgric,
        transfer_in: c.transferIn,
        transfer_out: c.transferOut,
        sales_ghs: c.salesGhs,
        broken: c.broken,

        paid_cash_ghs: c.paidCash,
        paid_momo_ghs: c.paidMoMo,
        momo_ref: c.momoRef || null,
        paid_ghs: c.paidGhs,

        paid_given: c.paidGiven,
        bonus: c.bonus,
        sold: c.sold,
        owner_due_given: c.ownerDueGiven,
        owner_due_sales: c.ownerDueSales,
        remaining: c.remaining
      };

      const { error } = await supabase.from("entries").insert(payload);
      if (error) {
        authMsg.textContent = "Save Fehler: " + error.message;
        return;
      }

      authMsg.textContent = "Gespeichert.";
      renderCalc(c, newDebt);

      // reset quick fields (keep stock + delivery as-is unless you want reset)
      fields.salesGhs.value = 0;
      fields.paidCash.value = 0;
      fields.paidMoMo.value = 0;
      fields.momoRef.value = "";
      syncPaidTotal();
      fields.paidCash.focus();
    }

    // Delivery helpers
    function toggleDelivery(){
      deliveryBox.style.display = (deliveryBox.style.display === "none") ? "block" : "none";
    }

    function addDelivery(){
      const qty = Number(deliveryQty.value) || 0;
      if (qty <= 0) return;
      const type = deliveryType.value;
      if (type === "local") fields.givenLocal.value = Number(fields.givenLocal.value || 0) + qty;
      if (type === "agric") fields.givenAgric.value = Number(fields.givenAgric.value || 0) + qty;
      deliveryQty.value = 0;
    }

    function clearDelivery(){
      fields.givenLocal.value = 0;
      fields.givenAgric.value = 0;
      deliveryQty.value = 0;
    }

    // Events
    async function loadApprovedEvents() {
      const { data, error } = await supabase
        .from("joint_event_requests")
        .select("id, title, kind, event_date, rule, qty_extra, status, active, joint_id")
        .eq("status", "approved")
        .eq("active", true);

      if (error) { $("eventsList").textContent = "Events load error: " + error.message; return; }

      const { data: joints } = await supabase.from("joints").select("id,name");
      const map = new Map((joints || []).map(j => [j.id, j.name]));

      const rows = (data || []).map(e => {
        const jname = map.get(e.joint_id) || "Unknown";
        const when = e.kind === "one_time" ? e.event_date : e.rule;
        return `• ${jname}: ${e.title} | ${when} | +${e.qty_extra}`;
      });

      $("eventsList").textContent = rows.length ? rows.join("\n") : "No approved events yet.";
    }

    async function loadPendingApprovals() {
      const container = $("adminApprovals");
      if (CURRENT_ROLE !== "admin") { container.textContent = ""; return; }

      const { data, error } = await supabase
        .from("joint_event_requests")
        .select("id, title, kind, event_date, rule, qty_extra, note, joint_id, status")
        .eq("status", "pending");

      if (error) { container.textContent = "Pending load error: " + error.message; return; }

      const { data: joints } = await supabase.from("joints").select("id,name");
      const map = new Map((joints || []).map(j => [j.id, j.name]));

      if (!data?.length) { container.textContent = "No pending event requests."; return; }

      container.innerHTML = "<b>Pending Event Requests (Admin)</b>\n";

      const user = (await supabase.auth.getUser()).data.user;

      data.forEach(e => {
        const jname = map.get(e.joint_id) || "Unknown";
        const when = e.kind === "one_time" ? e.event_date : e.rule;

        const line = document.createElement("div");
        line.style.marginTop = "8px";
        line.innerHTML = `
          ${jname}: ${e.title} | ${when} | +${e.qty_extra}${e.note ? " | " + e.note : ""}
          <button class="btn" data-id="${e.id}" data-act="approve">Approve</button>
          <button class="btn" data-id="${e.id}" data-act="reject">Reject</button>
        `;
        container.appendChild(line);

        line.querySelectorAll("button").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.getAttribute("data-id");
            const act = btn.getAttribute("data-act");

            const update = (act === "approve")
              ? { status: "approved", approved_by: user.id, approved_at: new Date().toISOString() }
              : { status: "rejected", approved_by: user.id, approved_at: new Date().toISOString() };

            const { error } = await supabase.from("joint_event_requests").update(update).eq("id", id);
            if (error) { alert(error.message); return; }
            await loadPendingApprovals();
            await loadApprovedEvents();
          };
        });
      });
    }

    async function createEventRequest() {
      const jointId = jointEl.value;

      const title = prompt("Event title (e.g. 'Monthly Bulk Order'):");
      if (!title) return;

      const kind = prompt("Type: one_time or recurring ?", "one_time");
      if (!kind || !["one_time","recurring"].includes(kind)) { alert("Invalid type"); return; }

      let event_date = null;
      let rule = null;

      if (kind === "one_time") {
        event_date = prompt("Event date (YYYY-MM-DD):");
        if (!event_date) return;
      } else {
        rule = prompt("Rule (e.g. LAST_SATURDAY):", "LAST_SATURDAY");
        if (!rule) return;
      }

      const qty = Number(prompt("Extra coconuts needed (e.g. 100):", "100") || "0");
      const note = prompt("Note (optional):", "") || null;

      const user = (await supabase.auth.getUser()).data.user;

      const payload = {
        joint_id: jointId,
        title,
        kind,
        event_date,
        rule,
        qty_extra: qty,
        note,
        requested_by: user.id
      };

      const { error } = await supabase.from("joint_event_requests").insert(payload);
      if (error) { alert(error.message); return; }

      alert("Event request submitted (pending admin approval).");
      await loadPendingApprovals();
      await loadApprovedEvents();
    }

    // Auth
    loginBtn.onclick = async () => {
      authMsg.textContent = "Login…";
      const email = $("email").value;
      const password = $("password").value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) authMsg.textContent = "Login Fehler: " + error.message;
    };

    logoutBtn.onclick = async () => { await supabase.auth.signOut(); };

    supabase.auth.onAuthStateChange(async (_event, session) => {
      if (session) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        appBox.style.display = "block";
        dateEl.value = todayISO();

        await loadRole(session);
        await loadJoints();

        // Wire buttons
        toggleDeliveryBtn.onclick = toggleDelivery;
        addDeliveryBtn.onclick = addDelivery;
        clearDeliveryBtn.onclick = clearDelivery;

        $("addEventBtn").onclick = createEventRequest;
        $("loadEventsBtn").onclick = async () => { await loadApprovedEvents(); await loadPendingApprovals(); };

        // Initial loads
        await loadApprovedEvents();
        await loadPendingApprovals();

        syncPaidTotal();
        authMsg.textContent = "Eingeloggt.";
      } else {
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        appBox.style.display = "none";
        rolePill.style.display = "none";
        CURRENT_ROLE = "foreman";
        authMsg.textContent = "Bitte einloggen.";
      }
    });

    jointEl.addEventListener("change", refreshDebt);
    fields.paidCash.addEventListener("input", syncPaidTotal);
    fields.paidMoMo.addEventListener("input", syncPaidTotal);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && appBox.style.display !== "none") saveEntry();
    });
    saveBtn.onclick = saveEntry;

    // initial
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      appBox.style.display = "block";
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      dateEl.value = todayISO();
      await loadRole(session);
      await loadJoints();
      await loadApprovedEvents();
      await loadPendingApprovals();
      syncPaidTotal();
      authMsg.textContent = "Eingeloggt.";
    } else {
      authMsg.textContent = "Bitte einloggen.";
    }
  </script>
</body>
</html>
